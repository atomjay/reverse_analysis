# 02_code_obfuscation: ç¨‹å¼ç¢¼æ··æ·†èˆ‡å»æ··æ·† - åˆ†æå ±å‘Š

## æ¦‚è¿°
æœ¬æ¨¡çµ„æ—¨åœ¨æ¢ç´¢ç¨‹å¼ç¢¼æ··æ·†æŠ€è¡“ï¼Œä¸¦å­¸ç¿’å¦‚ä½•é€ééœæ…‹åˆ†æå·¥å…·ï¼ˆIDA Pro / Hopperï¼‰ä¾†ç†è§£æ··æ·†å¾Œçš„ç¨‹å¼ç¢¼é‚è¼¯ã€‚æˆ‘å€‘é€éæ‰‹å‹•æ¨¡æ“¬æ··æ·†ï¼Œä¸¦è§€å¯Ÿç·¨è­¯å™¨å„ªåŒ–å°æ··æ·†æ•ˆæœçš„å½±éŸ¿ï¼Œå¾è€Œæ·±å…¥ç†è§£äº†å»æ··æ·†çš„æŒ‘æˆ°ã€‚

## 1. åˆå§‹è¨­å®šèˆ‡ç¨‹å¼ç·¨è­¯

æˆ‘å€‘é¦–å…ˆå‰µå»ºäº†ä¸€å€‹ç°¡å–®çš„ C ç¨‹å¼ `original_program.c`ï¼š

```c
#include <stdio.h>

int calculate_sum(int a, int b) {
    int sum = a + b;
    return sum;
}

int main() {
    int x = 10;
    int y = 20;
    int result = calculate_sum(x, y);
    printf("The sum is: %d\n", result);
    return 0;
}
```

ä¸¦ä½¿ç”¨ `clang` å°‡å…¶ç·¨è­¯ç‚ºå¯åŸ·è¡Œæ–‡ä»¶ `original_program`ã€‚`original_program` åŸ·è¡Œæ­£å¸¸ï¼Œè¼¸å‡º "The sum is: 30"ã€‚

## 2. æ‰‹å‹•æ¨¡æ“¬ç¨‹å¼ç¢¼æ··æ·†

ç‚ºäº†é¿å…è¤‡é›œçš„æ··æ·†å·¥å…·è¨­å®šï¼Œæˆ‘å€‘æ‰‹å‹•å‰µå»ºäº† `obfuscated_program.c`ï¼Œåœ¨ `calculate_sum` å‡½æ•¸ä¸­æ·»åŠ äº†ç°¡å–®çš„æ··æ·†é‚è¼¯ï¼š

```c
#include <stdio.h>

int calculate_sum(int a, int int_b) {
    int sum = 0;
    int temp_a = a;
    int temp_b = int_b;

    // Simple obfuscation: add and subtract to achieve the sum
    if (temp_a > 0) {
        for (int i = 0; i < temp_a; ++i) {
            sum++;
        }
    }

    if (temp_b > 0) {
        for (int i = 0; i < temp_b; ++i) {
            sum++;
        }
    }

    // Another layer of simple obfuscation
    int xor_val = 0xAA;
    sum = sum ^ xor_val;
    sum = sum ^ xor_val; // XORing twice returns original value

    return sum;
}

int main() {
    int x = 10;
    int y = 20;
    int result = calculate_sum(x, y);
    printf("The sum is: %d\n", result);
    return 0;
}
```

## 3. ç·¨è­¯å™¨å„ªåŒ–å°æ··æ·†çš„å½±éŸ¿

### 3.1 é¦–æ¬¡ç·¨è­¯ (é è¨­å„ªåŒ–)

æˆ‘å€‘é¦–å…ˆä½¿ç”¨ `clang` é è¨­å„ªåŒ–ç·¨è­¯ `obfuscated_program.c`ï¼š

```bash
clang -o projects/06_packing_unpacking/02_code_obfuscation/obfuscated_program projects/06_packing_unpacking/02_code_obfuscation/obfuscated_program.c
```

åœ¨ IDA Pro/Hopper ä¸­åç·¨è­¯ `calculate_sum` å‡½æ•¸ï¼Œçµæœå¦‚ä¸‹ï¼š

```c
__int64 __fastcall calculate_sum(int a1, int a2)
{
  return (unsigned int)(a1 + a2);
}
```

é€™è¡¨æ˜ç·¨è­¯å™¨å„ªåŒ–å™¨éå¸¸å¼·å¤§ï¼Œå®ƒå°‡æˆ‘å€‘æ‰‹å‹•æ·»åŠ çš„å¾ªç’°å’Œè‡ªæŠµæ¶ˆçš„ XOR æ“ä½œå®Œå…¨å„ªåŒ–æ‰äº†ï¼Œåªä¿ç•™äº†æœ€åŸå§‹çš„åŠ æ³•é‚è¼¯ã€‚é€™çªé¡¯äº†ç·¨è­¯å™¨å„ªåŒ–åœ¨é€†å‘å·¥ç¨‹ä¸­å¸¶ä¾†çš„æŒ‘æˆ°ã€‚

### 3.2 é‡æ–°ç·¨è­¯ (ç„¡å„ªåŒ– `-O0`)

ç‚ºäº†è§€å¯Ÿæˆ‘å€‘æ‰‹å‹•æ·»åŠ çš„æ··æ·†é‚è¼¯ï¼Œæˆ‘å€‘ä½¿ç”¨ `-O0` æ——æ¨™é‡æ–°ç·¨è­¯ `obfuscated_program.c`ï¼š

```bash
clang -O0 -o projects/06_packing_unpacking/02_code_obfuscation/obfuscated_program projects/06_packing_unpacking/02_code_obfuscation/obfuscated_program.c
```

é‡æ–°ç·¨è­¯å¾Œï¼Œåœ¨ IDA Pro/Hopper ä¸­åç·¨è­¯ `calculate_sum` å‡½æ•¸ï¼Œçµæœå¦‚ä¸‹ï¼š

```c
__int64 __fastcall calculate_sum(int a1, int a2)
{
  int j; // [xsp+4h] [xbp-1Ch]
  int i; // [xsp+8h] [xbp-18h]
  unsigned int v5; // [xsp+14h] [xbp-Ch]

  v5 = 0;
  if ( a1 > 0 )
  {
    for ( i = 0; i < a1; ++i )
      ++v5;
  }
  if ( a2 > 0 )
  {
    for ( j = 0; j < a2; ++j )
      ++v5;
  }
  return v5;
}
```

é€™æ¬¡ï¼Œæˆ‘å€‘æˆåŠŸçœ‹åˆ°äº†æ‰‹å‹•æ·»åŠ çš„æ··æ·†é‚è¼¯ï¼šå…©å€‹ `for` å¾ªç’°åˆ†åˆ¥å°‡ `a1` å’Œ `a2` çš„å€¼ç´¯åŠ åˆ° `v5` ä¸­ã€‚é€™è­‰æ˜äº† `-O0` æˆåŠŸåœ°é˜»æ­¢äº†ç·¨è­¯å™¨å„ªåŒ–ï¼Œä¿ç•™äº†åŸå§‹ç¨‹å¼ç¢¼çš„çµæ§‹ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿åœ¨ `-O0` çš„æƒ…æ³ä¸‹ï¼Œå…©æ¬¡ XOR æ“ä½œ (`sum = sum ^ xor_val; sum = sum ^ xor_val;`) ä¹Ÿæ²’æœ‰å‡ºç¾åœ¨åç·¨è­¯çµæœä¸­ã€‚é€™æ˜¯å› ç‚º `XOR` å…©æ¬¡ç›¸åŒçš„æ•¸æœƒå¾—åˆ°åŸå§‹å€¼ (`A ^ B ^ B = A`)ï¼Œç·¨è­¯å™¨è¶³å¤ è°æ˜ï¼Œèƒ½å¤ è­˜åˆ¥é€™ç¨®è‡ªæŠµæ¶ˆçš„æ¨¡å¼ä¸¦å°‡å…¶å„ªåŒ–æ‰ã€‚

## 4. å»æ··æ·†åˆ†æ

é€éå°åç·¨è­¯çµæœçš„åˆ†æï¼Œæˆ‘å€‘æˆåŠŸç†è§£äº† `calculate_sum` å‡½æ•¸çš„çœŸå¯¦é‚è¼¯ï¼šå®ƒé€éå…©å€‹å¾ªç’°å°‡å…©å€‹è¼¸å…¥åƒæ•¸ `a1` å’Œ `a2` çš„å€¼ç›¸åŠ ï¼Œæœ€çµ‚è¿”å›å®ƒå€‘çš„å’Œã€‚å„˜ç®¡ç¨‹å¼ç¢¼çœ‹èµ·ä¾†æ›´è¤‡é›œï¼Œä½†å…¶æ ¸å¿ƒåŠŸèƒ½ä¸¦æœªæ”¹è®Šã€‚

## 5. é—œéµå­¸ç¿’èˆ‡çµè«–

*   **ç·¨è­¯å™¨å„ªåŒ–çš„å½±éŸ¿ï¼š** ç·¨è­¯å™¨å„ªåŒ–æ˜¯é€†å‘å·¥ç¨‹ä¸­çš„ä¸€å€‹é‡è¦å› ç´ ã€‚å³ä½¿æ˜¯ç°¡å–®çš„ç¨‹å¼ç¢¼ï¼Œåœ¨å„ªåŒ–å¾Œä¹Ÿå¯èƒ½è®Šå¾—é›£ä»¥ç†è§£ã€‚åœ¨åˆ†ææ™‚ï¼Œéœ€è¦è€ƒæ…®ç·¨è­¯å™¨å„ªåŒ–å°ç¨‹å¼ç¢¼çµæ§‹çš„å½±éŸ¿ã€‚
*   **å»æ··æ·†çš„æŒ‘æˆ°ï¼š** ç¨‹å¼ç¢¼æ··æ·†æ—¨åœ¨å¢åŠ é€†å‘å·¥ç¨‹çš„é›£åº¦ã€‚å»æ··æ·†çš„éç¨‹éœ€è¦ä»”ç´°åˆ†æç¨‹å¼ç¢¼é‚è¼¯ï¼Œè­˜åˆ¥æ··æ·†æ¨¡å¼ï¼Œä¸¦æ¨æ–·åŸå§‹åŠŸèƒ½ã€‚
*   **å·¥å…·çš„é‡è¦æ€§ï¼š** IDA Pro æˆ– Hopper ç­‰å°ˆæ¥­åç·¨è­¯å™¨åœ¨ç†è§£æ··æ·†ç¨‹å¼ç¢¼æ–¹é¢ç™¼æ®è‘—é—œéµä½œç”¨ï¼Œå®ƒå€‘èƒ½å¤ å°‡çµ„è­¯ç¨‹å¼ç¢¼è½‰æ›ç‚ºæ›´æ˜“è®€çš„å½ä»£ç¢¼ã€‚

**æ¨¡çµ„ç‹€æ…‹ï¼šå·²å®Œæˆ** ğŸ‰

