# 04_symbol_stripping: ç¬¦è™Ÿç§»é™¤èˆ‡é€†å‘ - åˆ†æå ±å‘Š

## æ¦‚è¿°
æœ¬æ¨¡çµ„æ—¨åœ¨æ¢ç´¢ç¬¦è™Ÿç§»é™¤æŠ€è¡“å°é€†å‘å·¥ç¨‹çš„å½±éŸ¿ï¼Œä¸¦å­¸ç¿’å¦‚ä½•åœ¨ç¼ºä¹ç¬¦è™Ÿä¿¡æ¯çš„æƒ…æ³ä¸‹ï¼Œé€ééœæ…‹åˆ†æå·¥å…·ï¼ˆIDA Pro / Hopperï¼‰ä¾†è­˜åˆ¥å‡½æ•¸åŠŸèƒ½ã€‚æˆ‘å€‘æˆåŠŸåœ°é€éå­—ä¸²äº¤å‰å¼•ç”¨å’Œç¨‹å¼ç¢¼é‚è¼¯åˆ†æï¼Œæ¢å¾©äº†åŸå§‹å‡½æ•¸çš„èªç¾©ã€‚

## 1. åˆå§‹è¨­å®šèˆ‡ç¨‹å¼ç·¨è­¯

æˆ‘å€‘é¦–å…ˆå‰µå»ºäº†ä¸€å€‹åŒ…å«å¤šå€‹å‡½æ•¸çš„ C ç¨‹å¼ `original_program.c`ï¼š

```c
#include <stdio.h>

int add(int a, int b) {
    return a + b;
}

int subtract(int a, int b) {
    return a - b;
}

int multiply(int a, int b) {
    return a * b;
}

int main() {
    int x = 10;
    int y = 5;

    int sum = add(x, y);
    printf("Sum: %d\n", sum);

    int difference = subtract(x, y);
    printf("Difference: %d\n", difference);

    int product = multiply(x, y);
    printf("Product: %d\n", product);

    return 0;
}
```

ä¸¦ä½¿ç”¨ `clang` å°‡å…¶ç·¨è­¯ç‚ºå¯åŸ·è¡Œæ–‡ä»¶ `original_program`ã€‚`original_program` åŸ·è¡Œæ­£å¸¸ï¼Œè¼¸å‡ºäº†é æœŸçš„è¨ˆç®—çµæœã€‚

## 2. ç¬¦è™Ÿç§»é™¤

æˆ‘å€‘ä½¿ç”¨ `strip` å‘½ä»¤å° `original_program` é€²è¡Œç¬¦è™Ÿç§»é™¤ï¼Œç”Ÿæˆ `stripped_program`ï¼š

```bash
strip -o projects/06_packing_unpacking/04_symbol_stripping/stripped_program projects/06_packing_unpacking/04_symbol_stripping/original_program
```

`stripped_program` åŸ·è¡Œæ­£å¸¸ï¼Œèˆ‡åŸå§‹ç¨‹å¼è¼¸å‡ºç›¸åŒï¼Œé€™è­‰å¯¦äº†ç¬¦è™Ÿç§»é™¤ä¸æœƒå½±éŸ¿ç¨‹å¼çš„åŸ·è¡ŒåŠŸèƒ½ã€‚

## 3. é€†å‘åˆ†æç¬¦è™Ÿç§»é™¤å¾Œçš„ç¨‹å¼

æˆ‘å€‘ä½¿ç”¨ IDA Pro æˆ– Hopper å° `stripped_program` é€²è¡Œéœæ…‹åˆ†æã€‚

### 3.1 è§€å¯Ÿç¬¦è™Ÿç§»é™¤çš„æ•ˆæœ

åœ¨ IDA Pro/Hopper çš„å‡½æ•¸åˆ—è¡¨ä¸­ï¼Œæˆ‘å€‘ç™¼ç¾åŸå§‹çš„å‡½æ•¸åç¨±ï¼ˆå¦‚ `main`, `add`, `subtract`, `multiply`ï¼‰éƒ½è¢«æ›¿æ›ç‚ºé€šç”¨åç¨±ï¼Œä¾‹å¦‚ `sub_XXXX` æˆ– `loc_XXXX`ã€‚é€™ä½¿å¾—ç¨‹å¼ç¢¼çš„é–±è®€å’Œç†è§£è®Šå¾—æ›´åŠ å›°é›£ã€‚

### 3.2 è­˜åˆ¥ `main` å‡½æ•¸

ç”±æ–¼ `main` å‡½æ•¸çš„ç¬¦è™Ÿä¹Ÿè¢«ç§»é™¤ï¼Œæˆ‘å€‘ç„¡æ³•ç›´æ¥æ‰¾åˆ°å®ƒã€‚æˆ‘å€‘åˆ©ç”¨ç¨‹å¼ä¸­ä»ç„¶å­˜åœ¨çš„å­—ä¸²ä½œç‚ºç·šç´¢ã€‚æˆ‘å€‘åœ¨å­—ä¸²è¦–åœ–ä¸­æ‰¾åˆ°äº†ä»¥ä¸‹å­—ä¸²ï¼š

*   "Sum: %d\n"
*   "Difference: %d\n"
*   "Product: %d\n"

é€éæŸ¥çœ‹é€™äº›å­—ä¸²çš„äº¤å‰å¼•ç”¨ï¼Œæˆ‘å€‘ç™¼ç¾å®ƒå€‘éƒ½è¢« `start` å‡½æ•¸å¼•ç”¨ã€‚é€™è¡¨æ˜ `start` å‡½æ•¸å°±æ˜¯æˆ‘å€‘åŸå§‹ç¨‹å¼ä¸­çš„ `main` å‡½æ•¸ï¼ˆæˆ–å…¶ç­‰æ•ˆçš„å…¥å£å‡½æ•¸ï¼‰ã€‚

### 3.3 è­˜åˆ¥ `add`, `subtract`, `multiply` å‡½æ•¸

åˆ†æ `start` å‡½æ•¸çš„åç·¨è­¯å½ä»£ç¢¼ï¼Œæˆ‘å€‘è§€å¯Ÿåˆ°å®ƒèª¿ç”¨äº†ä¸‰å€‹æ²’æœ‰æ˜ç¢ºåç¨±çš„å‡½æ•¸ï¼Œä¸¦å°‡å®ƒå€‘çš„è¿”å›å€¼èˆ‡ä¸Šè¿°å­—ä¸²ä¸€èµ·æ‰“å°ï¼š

```c
__int64 start()
{
  int v1; // [xsp+18h] [xbp-18h]
  int v2; // [xsp+1Ch] [xbp-14h]
  int v3; // [xsp+20h] [xbp-10h]

  v3 = sub_100000460(10, 5);
  printf("Sum: %d\n", v3);
  v2 = sub_100000480(10, 5);
  printf("Difference: %d\n", v2);
  v1 = sub_1000004A0(10, 5);
  printf("Product: %d\n", v1);
  return 0;
}
```

æ ¹æ“šèª¿ç”¨ä¸Šä¸‹æ–‡å’Œæ‰“å°çš„å­—ä¸²ï¼Œæˆ‘å€‘æˆåŠŸæ¨æ–·å‡ºé€™äº›å‡½æ•¸çš„åŠŸèƒ½ï¼š

*   `sub_100000460` åŸ·è¡ŒåŠ æ³•æ“ä½œï¼Œå°æ‡‰ `add` å‡½æ•¸ã€‚
*   `sub_100000480` åŸ·è¡Œæ¸›æ³•æ“ä½œï¼Œå°æ‡‰ `subtract` å‡½æ•¸ã€‚
*   `sub_1000004A0` åŸ·è¡Œä¹˜æ³•æ“ä½œï¼Œå°æ‡‰ `multiply` å‡½æ•¸ã€‚

æˆ‘å€‘é€²ä¸€æ­¥é©—è­‰äº† `add` å‡½æ•¸çš„åç·¨è­¯å½ä»£ç¢¼ï¼Œç¢ºèªå…¶ç¢ºå¯¦åŸ·è¡Œäº†åŠ æ³•ï¼š

```c
__int64 __fastcall add(int a1, int a2)
{
  return (unsigned int)(a1 + a2);
}
```

## 4. é—œéµå­¸ç¿’èˆ‡çµè«–

*   **ç¬¦è™Ÿç§»é™¤çš„å½±éŸ¿ï¼š** ç¬¦è™Ÿç§»é™¤æœƒé¡¯è‘—å¢åŠ é€†å‘å·¥ç¨‹çš„é›£åº¦ï¼Œå› ç‚ºå®ƒç§»é™¤äº†å‡½æ•¸å’Œè®Šæ•¸çš„èªç¾©ä¿¡æ¯ã€‚
*   **å­—ä¸²äº¤å‰å¼•ç”¨çš„é‡è¦æ€§ï¼š** åœ¨ç¼ºä¹ç¬¦è™Ÿä¿¡æ¯çš„æƒ…æ³ä¸‹ï¼Œå­—ä¸²äº¤å‰å¼•ç”¨æ˜¯å®šä½é—œéµç¨‹å¼ç¢¼å€åŸŸï¼ˆå¦‚ `main` å‡½æ•¸ï¼‰çš„æœ‰æ•ˆæ–¹æ³•ã€‚
*   **ç¨‹å¼ç¢¼é‚è¼¯æ¨æ–·ï¼š** å³ä½¿æ²’æœ‰ç¬¦è™Ÿï¼Œä¹Ÿå¯ä»¥é€éåˆ†æå‡½æ•¸çš„è¼¸å…¥ã€è¼¸å‡ºå’Œå…§éƒ¨é‚è¼¯ä¾†æ¨æ–·å…¶åŠŸèƒ½ã€‚
*   **å·¥å…·çš„æ‡‰ç”¨ï¼š** IDA Pro æˆ– Hopper ç­‰å°ˆæ¥­åç·¨è­¯å™¨åœ¨åˆ†æç¬¦è™Ÿç§»é™¤å¾Œçš„ç¨‹å¼ç¢¼æ–¹é¢ç™¼æ®è‘—é—œéµä½œç”¨ï¼Œå®ƒå€‘çš„åç·¨è­¯åŠŸèƒ½æœ‰åŠ©æ–¼ç†è§£åº•å±¤é‚è¼¯ã€‚

**æ¨¡çµ„ç‹€æ…‹ï¼šå·²å®Œæˆ** ğŸ‰
